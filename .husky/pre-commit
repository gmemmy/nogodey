echo "ğŸš€ Running pre-commit hooks..."

# Check if we're in the js directory or need to cd into it
if [ -f "package.json" ]; then
  JS_DIR="."
else
  JS_DIR="js"
fi

# JavaScript/TypeScript checks
echo "ğŸ“ Running JavaScript/TypeScript checks..."
cd "$JS_DIR" || exit 1

# Run lint-staged for staged files
echo "ğŸ”§ Running lint-staged..."
npx lint-staged

# Type checking
echo "ğŸ” Running TypeScript type check..."
pnpm run typecheck

# Run tests
echo "ğŸ§ª Running tests..."
pnpm run test:ci

cd - > /dev/null || exit 1

# Go checks 
if [ -f "go.mod" ]; then
  echo "ğŸ¹ Running Go checks..."
  
  # Check if there are any Go files staged
  GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)
  
  if [ -n "$GO_FILES" ]; then
    echo "ğŸ” Formatting Go files..."
    go fmt ./...
    
    echo "ğŸ” Running go vet..."
    go vet ./...
    
    echo "ğŸ§ª Running Go tests..."
    go test ./...
    
    # Add formatted files back to staging
    echo "$GO_FILES" | xargs git add
  else
    echo "â„¹ï¸  No Go files staged for commit"
  fi
else
  echo "â„¹ï¸  No Go module found, skipping Go checks"
fi

echo "âœ… All pre-commit checks passed!"
