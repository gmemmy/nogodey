#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üöÄ Running pre-push hooks..."

# Check if we're in the js directory or need to cd into it
if [ -f "package.json" ]; then
  JS_DIR="."
else
  JS_DIR="js"
fi

# JavaScript/TypeScript comprehensive checks
echo "üìù Running comprehensive JavaScript/TypeScript checks..."
cd "$JS_DIR" || exit 1

echo "üîç Running full Biome check..."
npm run biome:ci

echo "üîç Running TypeScript type check..."
npm run typecheck

echo "üß™ Running full test suite with coverage..."
npm run test:ci

cd - > /dev/null || exit 1

# Go comprehensive checks (if Go files are present)
if [ -f "go.mod" ]; then
  echo "üêπ Running comprehensive Go checks..."
  
  echo "üîç Running go vet..."
  go vet ./...
  
  echo "üîç Running go mod tidy..."
  go mod tidy
  
  echo "üß™ Running Go tests with race detection..."
  go test -race ./...
  
  echo "üîç Checking for Go vulnerabilities..."
  if command -v govulncheck > /dev/null 2>&1; then
    govulncheck ./...
  else
    echo "‚ÑπÔ∏è  govulncheck not installed, skipping vulnerability check"
    echo "‚ÑπÔ∏è  Install with: go install golang.org/x/vuln/cmd/govulncheck@latest"
  fi
else
  echo "‚ÑπÔ∏è  No Go module found, skipping Go checks"
fi

echo "‚úÖ All pre-push checks passed!" 